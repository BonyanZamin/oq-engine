apiVersion: batch.volcano.sh/v1alpha1
kind: Job
metadata:
  name: oq-job
spec:
  minAvailable: 3
  schedulerName: volcano
  plugins:
    ssh: []
    svc: []
    env: []
    tasks:
    - replicas: 1
      name: oqmaster
      policies:
        - event: TaskCompleted
          action: CompleteJob
      template:
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |
                  sudo sed -i "s@^host = .*@host = $(cat /etc/volcano/oqmaster.host | tr '\n' , | sed 's/\(\.oq-job\)/\2 /g')@g;s/,/, /g" /opt/openquake/openquake.cfg ;
                  sudo sed -i "s@^host_cores =.*@host_cores = $(cat /etc/volcano/oqworker.host | tr '\n' , | sed 's/,$//g' | sed 's/\(\.oq-job\)/\1 -1/g')@g;s/,/, /g" /opt/openquake/openquake.cfg;
                  #nomore needed to start
                  echo "sleep 30";
                  sleep 30;
                  #for file in $(cat /etc/volcano/oqworker.host ); do ssh -f -T "$file" /opt/openquake/bin/python3 -m openquake.baselib.workerpool ; done
                  #start db server
                  /home/openquake/oq-db_start.sh;
                  echo "sleep 30";
                  sleep 30;
                  oq engine --run "https://downloads.openquake.org/pkgs/test_event_based_risk_inputs_bc.zip" ;
              image: openquake/engine:exp
              imagePullPolicy: Always
              name: master
              #resources:
              #  limits:
              #    memory: "8Gi"
              #    cpu: "8"
              #  requests:
              #    memory: "4Gi"
              #    cpu: "4"
              ports:
                - containerPort: 1909
                  name: oqjob-port
              workingDir: /home/openquake
          #restartPolicy: OnFailure
          restartPolicy: Never
    - replicas: 3
      name: oqworker
      template:
        spec:
          containers:
            - command:
                - /bin/sh
                - -c
                - |
                  sudo mkdir /run/sshd;
                  sudo /usr/sbin/sshd -D;
              image: openquake/engine:exp
              imagePullPolicy: Always
              name: worker
              ports:
                - containerPort: 1909
                  name: oqjob-port
              workingDir: /home/openquake
          #restartPolicy: OnFailure
          restartPolicy: Never
---
